# Virtually Non-Volatile Heap (vNV-Heap)

This repository contains the implementation and evaluation for the academic paper "Ownership-based Virtual Memory for Intermittently-Powered Embedded Systems" ([https://arxiv.org/abs/2501.17707](https://arxiv.org/abs/2501.17707)).

## Usage

### Overview

The vNV-Heap is designed as a platform independent Rust library. It supports modules that can easily be replaced to change vNV-Heap's behavior.

To use the vNV-Heap in your application follow these steps.

1. Add the vNV-Heap library as a dependency in your application:

    ```toml
    vnv_heap = { path = "../vnv_heap", features = [] }
    ```

    Possible features are:

    - `benchmarks`: Enable benchmarking for this application. Look at [desktop_benchmark](desktop_benchmark/) or [zephyr/vnv_heap_benchmark](zephyr/vnv_heap_benchmark/) for examples.
    - `persist_debug_prints`: Enable safe debug prints during persisting. This feature uses the `write` system call and thus depends on `libc`, meaning it cannot be used in all environments.
    - `persist_debug_unsafe_prints`: **THIS FEATURE IS UNSAFE! USE IT WITH CAUTION!!!** Enables unsafe debug prints during persisting. This features uses the standard println! macro. This however can result in undesired behavior as its implementation is commonly not reentrant.

2. Define your own modules if needed:

    There already exist some implementations for the modules:

    - `AllocatorModule` (Defined a strategy to allocate data in a RAM buffer. Any kind of heap can be implemented for this.)
        - `BuddyAllocatorModule`
        - `LinkedListAllocatorModule`
    - `NonResidentAllocatorModule` (Defines a strategy to allocate data on a non-volatile external storage device. This has to be efficient due to high delay.)
        - `NonResidentBuddyAllocatorModule`
    - `ObjectManagementModule` (Defines which objects should be unloaded and persisted)
        - `DefaultObjectManagementModule`: This module currently iterates over the list of resident objects and unloads/persists them it that order.
    - `PersistentStorageModule` (Defines an interface for reading and writing data to a storage device)
        - `FilePersistentStorageModule`: Uses files as a way to store non-volatile data. Note that this module does not ensure to flush its data.

3. Start using vNV-Heap with your own modules:

    ```rust
    fn main() {
        // initiate your storage module
        let storage = FilePersistentStorageModule::new("test.data".to_string(), 4096).unwrap();
        let config = VNVConfig {
            // specify the limit of bytes that are allowed to be dirty at the same time
            max_dirty_bytes: 1024,
        };
        // initiate the buffer for resident objects and metadata
        let mut buffer = [0u8; 2048];
        // initiate the internal heap module that operates on the previously defined buffer
        let heap = LinkedListAllocatorModule::new();

        // initiate the heap and specify all modules
        let heap: VNVHeap<
            LinkedListAllocatorModule,
            NonResidentBuddyAllocatorModule<16>,
            DefaultObjectManagementModule,
            FilePersistentStorageModule
        > = VNVHeap::new(
            &mut buffer,
            storage,
            heap,
            config,
            // persist finished handler
            |_, _| {
                // called once vNV-Heap's state is fully persisted
                
                // now call the OS to persist its state
                // this call returns once power is available again and the
                // OS restored its state
                persist_finished();

                // after returning from this handler, the vNV-Heap will restore its state
            }
        ).unwrap();

        {
            // allocate new counter (the counter struct is defined below)
            let mut obj = heap.allocate::<Counter>(Counter::new(0)).unwrap();

            {
                // print current value
                let obj_ref = obj.get().unwrap();
                println!("counter: {}", obj_ref.get_val());
            } // implicit drop of immutable reference: object could be unloaded

            // do something in between...

            {
                // increase the value by 100
                let mut mut_ref = obj.get_mut().unwrap();
                mut_ref.increase();
                println!("counter: {}", mut_ref.get_val());
                mut_ref.increase_by(100);
            } // implicit drop of mutable reference: object could be synchronized/unloaded

            // do something in between...

            {
                // print current value
                let obj_ref = obj.get().unwrap();
                println!("counter: {}", obj_ref.get_val());
            } // implicit drop of immutable reference: object could be unloaded

        } // implicit drop of obj1: free memory
    }

    // should be called once power failure is imminent
    // persist the state of the initialized vNV-Heap
    fn persist() {
        // unsafe: this should not be called if another
        // call of this function did not finish yet
        unsafe { vnv_persist_all() };
    }

    // define a sample counter struct
    struct Counter {
        val: u32
    }

    impl Counter {
        fn new(initial_value: u32) -> Self { Self { val: initial_value } }
        fn increase(&mut self) { self.val += 1; }
        fn increase_by(&mut self, inc: u32) { self.val += inc; }
        fn get_val(&self) -> u32 { self.val }
    }
    ```

    *This example is also available in the [counter_example](counter_example/) directory.*

### Examples

Examples for using vNV-Heap can be found in different directories:

- [counter_example](counter_example/): Simple counter example. You can run it by executing `cargo run`.
- [desktop_persist](desktop_persist/): Example how to use the persist interrupt to persist vNV-Heap. Run [desktop_persist/run_checked_output.sh](desktop_persist/run_checked_output.sh) to automatically persist the vNV-Heap multiple times a second.
- [desktop_playground](desktop_playground/): Another simple usage example. You can run it by executing `cargo run`.
- [zephyr/vnv_heap_persist](zephyr/vnv_heap_persist/): A example that uses a button to trigger persists on an ESP32-C3 with a Fujitsu MB85RS64V FRAM module and Zephyr RTOS. Follow [these](#getting-started-with-zephyr) instructions to get started with Zephyr. Pin connections:
  - SCK: Pin 6
  - MISO: Pin 2
  - MOSI: Pin 7
  - CS: Pin 1
  - Button: Connect with GRND and Pin 0
- [zephyr/vnv_heap_sample](zephyr/vnv_heap_sample/): Another basic example how to use vNV-Heap that uses Zephyr RTOS. Follow [these](#getting-started-with-zephyr) instructions to get started with Zephyr. Pin connections:
  - SCK: Pin 6
  - MISO: Pin 2
  - MOSI: Pin 7
  - CS: Pin 1

## Getting Started with Zephyr

To setup the toolchain for compiling the zephyr projects located in the [zephyr](zephyr/) directory, follow these instructions:

1. Follow the installation instructions of [zephyr-rust](https://github.com/tylerwhall/zephyr-rust/tree/ff51ff709f79b2adbcbd0c34644eab59bce0dc11) at commit *ff51ff709f79b2adbcbd0c34644eab59bce0dc11*. This requires Rust *1.75.0*. Using Zephyr *3.7.0* is recommended. Notes:
    - It is important to activate the zephyr environment every time you work with it.
    - Also make sure to use *zephyr-rust* as a Zephyr module. You can achieve this by setting the following environment variables in the `~/.zephyrrc`:

        ```bash
        export ZEPHYR_EXTRA_MODULES=~/zephyr-rust
        export WEST_BASE=~/zephyrproject
        export ZEPHYR_BASE=~/zephyrproject/zephyr
        ```

2. Add a link to your `zephyr-rust` directory in the [zephyr](zephyr/) directory so it looks like this: `zephyr/zephyr-rust/[content of zephyr-rust]`
3. Add following lines to the contents of `rust/zephyr-sys/wrapper.h` in your `zehpyr-rust` directory (this will enable the generation of Rust bindings for the SPI interfaces):

    ```c
    #ifdef CONFIG_SPI
    #include <zephyr/drivers/spi.h>
    #endif
    ```

4. *[Optional]*: Only necessary if you want to run this on an ESP32-C3. (*Explanation*: These steps are necessary because the vNV-Heap requires atomics, but the ESP32-C3 does not provide the "a" cpu extension as it only contains a single RISC-V core. However, atomics can be "simulated" solely by turning off interrupts until an atomic operation is finished.)
    1. Enable atomics for the target by editing the file in `zephyr-rust/rust/tagets/riscv32imc-unknown-zephyr-elf.json`. Now set `atomic-cas` to `true` and `target-pointer-width` to `32`. The contents of the file should now look like this:

        ```json
        {
            "arch": "riscv32",
            "atomic-cas": true,
            "cpu": "generic-rv32",Virtually Non-Volatile
            "data-layout": "e-m:e-p:32:32-i64:64-n32-S128",
            "eh-frame-header": false,
            "emit-debug-gdb-scripts": false,
            "features": "+m,+c",
            "linker": "rust-lld",
            "linker-flavor": "ld.lld",
            "llvm-target": "riscv32",
            "max-atomic-width": 32,
            "panic-strategy": "abort",
            "relocation-model": "static",
            "target-pointer-width": "32",
            "target-family": "zephyr",
            "os": "zephyr",
            "position-independent-executables": "false",
            "dynamic-linking": "false",
            "has-thread-local": "false"
        }
        ```

    2. If you now connect an ESP32-C3 you should now be able to run the pre-defined scripts e.g. `run_debug.sh`, `run_release.sh`. Use `FLASH=0` to only compile the code and to disable flashing it.
    3. Additionally, if you attach an MB85RS64V FRAM module as in [this configuration](#examples) you can run the pre-defined benchmarks in [zephyr/vnv_heap_benchmark](zephyr/vnv_heap_benchmark/) yourself. A easy way to do this is to execute the `run_benchmark.sh` script.

## Benchmarking

The benchmarks developed for the vNV-Heap are designed to be platform independent and are located in [vnv_heap/src/benchmarks](vnv_heap/src/benchmarks/).

A big advantage of this architecture is that it allows for easy debugging (e.g. to find bugs) because the benchmarks can be verified on desktop machines instead of flashing an the target MCU for every code change.

The projects to run the benchmarks are located in:

- For Desktop: [desktop_benchmark](desktop_benchmark/)
- For Zephyr: [zephyr/vnv_heap_benchmark](zephyr/vnv_heap_benchmark/)

### Desktop

To execute the benchmarks on a desktop machine, run the following in the [desktop_benchmark](desktop_benchmark/) directory:

```bash
cargo run
```

### Zephyr - ESP32-C3

To execute the benchmarks on an *ESP32-C3* with the *Zephyr RTOS* and a *Fujitsu MB85RS64V FRAM module*, run:

```bash
./zephyr/vnv_heap_benchmark/run_benchmark.sh
```

This automatically starts the benchmarks and records the results in a json file.
This json file can then be used in the JupyterNotebooks found in [zephyr/vnv_heap_benchmark/analysis](zephyr/vnv_heap_benchmark/analysis/).

Benchmark results recorded for the ESP32-C3 with a Fujitsu MB85RS64V FRAM module and the Zephyr RTOS are saved as JSON files in [zephyr/vnv_heap_benchmark/output](zephyr/vnv_heap_benchmark/output).

<details>
  <summary>Running benchmarks looks like this on zephyr (benchmarks also include a nice progress indicator which depends on the selected benchmarks for one specific run):</summary>

```text
[...]

[98%] Running Benchmark "persistent_storage_write" with options {"object_size":896,"persistent_storage_module":"vnv_heap::modules::persistent_storage::access_distribution::SharedStorageReference"}
[BENCH-INFO] {"bench_name":"persistent_storage_write","bench_options":{"object_size":896,"persistent_storage_module":"vnv_heap::modules::persistent_storage::access_distribution::SharedStorageReference"},"machine_name":"esp32c3","cold_start":100,"repetitions":1000,"ticks_per_ms":16000,"data":[17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480,17480]}
-> Finished persistent_storage_write: mean=17480, min=17480, max=17480

[99%] Running Benchmark "persistent_storage_write" with options {"object_size":928,"persistent_storage_module":"vnv_heap::modules::persistent_storage::access_distribution::SharedStorageReference"}
[BENCH-INFO] {"bench_name":"persistent_storage_write","bench_options":{"object_size":928,"persistent_storage_module":"vnv_heap::modules::persistent_storage::access_distribution::SharedStorageReference"},"machine_name":"esp32c3","cold_start":100,"repetitions":1000,"ticks_per_ms":16000,"data":[17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875,17875]}
-> Finished persistent_storage_write: mean=17875, min=17875, max=17875

[99%] Running Benchmark "persistent_storage_read" with options {"object_size":8192,"persistent_storage_module":"vnv_heap::modules::persistent_storage::access_distribution::SharedStorageReference"}
[BENCH-INFO] {"bench_name":"persistent_storage_read","bench_options":{"object_size":8192,"persistent_storage_module":"vnv_heap::modules::persistent_storage::access_distribution::SharedStorageReference"},"machine_name":"esp32c3","cold_start":100,"repetitions":1000,"ticks_per_ms":16000,"data":[182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862,182862]}
-> Finished persistent_storage_read: mean=182862, min=182862, max=182862

[99%] Running Benchmark "persistent_storage_write" with options {"object_size":8192,"persistent_storage_module":"vnv_heap::modules::persistent_storage::access_distribution::SharedStorageReference"}
[BENCH-INFO] {"bench_name":"persistent_storage_write","bench_options":{"object_size":8192,"persistent_storage_module":"vnv_heap::modules::persistent_storage::access_distribution::SharedStorageReference"},"machine_name":"esp32c3","cold_start":100,"repetitions":1000,"ticks_per_ms":16000,"data":[150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486,150486]}
-> Finished persistent_storage_write: mean=150486, min=150486, max=150486

[BENCH-STATUS] Finished in 0h 44m 6s
Saved file to "output/2024-08-27 11-40-37.json"
```

</details>

## Testing

Run following command to run the pre-defined test suite:

```bash
cargo test
```

Currently, this includes a total of **28 tests** ranging from simple module tests to large system tests.
Of course these tests don't catch all cases, but give a first indication when a major invariant is violated.
